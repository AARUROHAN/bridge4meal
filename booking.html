<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Book Worker - Bridge4Meal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body class="min-h-screen bg-white flex items-start justify-center pt-24 pb-12">
  <div class="w-full max-w-xl p-6">
    <div class="bg-white shadow rounded-lg p-6">
      <div class="flex items-center gap-3 mb-4">
        <img src="assets/logo.png" alt="logo" class="h-10 w-10 object-contain">
        <h2 class="text-2xl font-bold">Book a Worker</h2>
      </div>

      <form id="bookingForm" class="space-y-3">
        <input id="b_name" type="text" placeholder="Name" class="w-full px-3 py-2 border rounded" required />
        <input id="b_phone" type="tel" placeholder="Phone" class="w-full px-3 py-2 border rounded" required />
        <input id="b_service" type="text" placeholder="Service Required" class="w-full px-3 py-2 border rounded" required />
        <input id="b_address" type="text" placeholder="Address / Location" class="w-full px-3 py-2 border rounded" required />
        <input id="b_date" type="text" placeholder="Preferred Date (DD/MM/YYYY)" class="w-full px-3 py-2 border rounded" required />
        <input id="b_time" type="text" placeholder="Preferred Time (e.g., 10:00 AM)" class="w-full px-3 py-2 border rounded" required />
        <div class="flex gap-2">
          <button type="submit" class="flex-1 py-2 bg-gradient-to-r from-pink-500 to-blue-500 text-white rounded">Send Booking (WhatsApp)</button>
          <a href="index.html" class="px-4 py-2 border rounded self-center">Cancel</a>
        </div>
      </form>
    </div>
  </div>

  <script src="script.js"></script>
  <script>
    // ensure user is signed in; if not, send to signup
    const cur = getCurrentUser();
    const urlParams = new URLSearchParams(location.search);
    const serviceParam = urlParams.get('service') || '';
    if(!cur){
      // redirect to signup with service preserved
      const dest = serviceParam ? `signup.html?service=${encodeURIComponent(serviceParam)}` : 'signup.html';
      alert('You must create an account and sign in before booking.');
      window.location.href = dest;
    } else {
      // prefill name/phone/service if available
      if(cur.name) document.getElementById('b_name').value = cur.name;
      if(cur.mobile) document.getElementById('b_phone').value = cur.mobile;
      if(serviceParam) document.getElementById('b_service').value = serviceParam;
    }

    document.getElementById('bookingForm').addEventListener('submit', function(e){
      e.preventDefault();
      const name = document.getElementById('b_name').value.trim();
      const phone = document.getElementById('b_phone').value.trim();
      const service = document.getElementById('b_service').value.trim();
      const address = document.getElementById('b_address').value.trim();
      const date = document.getElementById('b_date').value.trim();
      const time = document.getElementById('b_time').value.trim();
      if(!name||!phone||!service||!address||!date||!time){ alert('All fields required'); return; }

      const msg = `Hello Bridge4Meal Team,\nI would like to book a worker.\n\nName: ${name}\nPhone: ${phone}\nService Required: ${service}\nAddress: ${address}\nPreferred Date: ${date}\nPreferred Time: ${time}`;
      const waUrl = `https://wa.me/919797548434?text=${encodeURIComponent(msg)}`;
      window.open(waUrl, '_blank');

      // send email (kept same format as before)
      emailjs.init("HWCoTybKtzkaS17Gh");
      emailjs.send('service_4jhdrif','template_nhc5g66',{
        subject: 'New Booking Request',
        message: msg + `\nBooked via: ${cur ? (cur.email || cur.mobile || 'unknown') : 'unknown'}`
      }).catch(err=> console.warn('EmailJS booking failed', err));
    });
  </script>
</body>
</html>
